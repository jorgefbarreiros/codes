clc; clear all; close all

%% Based on Nispi Landi closed economy TANK, modified by Jorge Fernandez

%% Structural Parameters (quarterly calibration)
beta=0.99;                    % discount factor (standard)
alpha=0.3621;                   % elasticity of production wrt capital (JFV ET AL 2009)
epsilon=9;                    % elasticity of substitution btw differentiated goods (JFV ET AL 2009)
delta=0.0175;                  % depreciation rate (JFV ET AL 2009)
sigma=1;                      % relative risk aversion (Bilbiie 2021)
phi=1;                        % inverse of Frisch elasticity (Bilbiie 2021)
g=0.2;                        % share of public spending in ss (data)
eta=1.5;                      % elasticity of intratemporal substitution (standard)
share = 0.24;                  % HTM households (arroyo tisn√©s 2024)
gamma=0.4;                    % trade openness (data)
D=0.2;                       % external debt/GDP ratio
tariff = 0.01;
tariffsp = 0.01;
theta_retaliation = 0.6;
%% Steady State
pi=1;                        % inflation targeting (quarterly calibration)
d=4*D;                       % foreign debt
y=1;                         % domestic output
pH=1;                        % domestic price
s=1;                         % real FX rate
h=1/3;                       % hours of work
rr=1/beta;                   % real interest rate
r=pi/beta;                   % nominal interest rate
q=1;                         % marginal value of investment (in terms of lambda)  
rk=1/beta-(1-delta);         % rental rate of capital
mc=(epsilon-1)/epsilon;      % real marginal costs
k=alpha*mc*y/rk;             % capital
w=(1-alpha)*mc*y/h;          % real wage
i=delta*k;                   % investment
c=y-i-g-d*(1/beta-1);       % consumption
tariffss = tariff;
lambda=(c)^(-sigma);   % marginal utlity of consumption
kappaL=lambda*w/(h^(phi));          % labor preference parameter
a=y/(k^(alpha)*h^(1-alpha)); % tfp
gammaz=1-(1-gamma)*(c+i)-g;  % foreign parameter
t_r=w*h-c;                   % restricted taxes
t_o=(g+(1/beta-1)*d-share*t_r)/(1-share); % optimizers taxes

%% Steady-state values
gss=g;
ass=a;
piss=pi;
rss=r;
dss=d;
t_oss= t_o;
t_rss= t_r;

%% Parameters not affecting the steady state
phipi=1.5;                % mp response to inflation 
phiy=0.1;                 % mp response to output 
phie=0;                   % mp response to exchange rate
phig=0.1;                 % tax reaction to g
phid=0.33;                % tax reaction to debt
phitariff=0.0005;
kappaI=2.48;              % investment adjustment cost (as in CEE). If 0, q is constant
kappaD=0.001;             % usually calibrated at a small value. If 0, the model has a unit root
rhoa=0.9;                 % tfp persistence
rhog=0.9;                 % public spending persistence
rhop=0.9;                 % foreign mp shock persistence
rhoy=0.9;                 % foreign demand shock persistence persistence
rhom=0.8;                 % monetary policy inertia
rhotariff = 0.95;
calvo=0.75;               % price rigidity in calvo framework
% adjusment cost coefficient to have the same linear Phillips Curve of the Calvo framework 
% complicated
kappaP=(epsilon-1)*calvo/(piss^2*(1-calvo)*(1-beta*calvo)); % adjusment 
%% Save parameters
save par beta alpha delta sigma phi eta gamma gammaz gss ass kappaL piss rss epsilon dss...
         phipi phiy phie phitariff kappaI kappaD rhoa rhog rhop theta_retaliation rhoy rhom kappaP share rhotariff tariffss

%% Dynare
addpath(genpath('/Applications/Dynare/6.3-arm64/matlab'));
dynare tank7 noclearall
rmpath(genpath('/Applications/Dynare/6.3-arm64/matlab'));

fig = figure(1);                            % Get handle to the figure
axes_handles = findall(fig, 'type', 'axes');  % Get all subplot axes

fig = figure(1);  % Get the handle to the IRF figure
axes_handles = findall(fig, 'Type', 'Axes');  % Get all subplots (axes)

for i = 1:length(axes_handles)
    lines = findall(axes_handles(i), 'Type', 'Line');
    
    % Loop through lines and set colors based on their vertical data
    for j = 1:length(lines)
        ydata = get(lines(j), 'YData');
        if all(ydata == 0)
            % This is the zero line
            set(lines(j), 'Color', [0.2 0.6 1], 'LineWidth', 1);  % Dark blue
        else
            % This is the IRF line
            set(lines(j), 'Color', [0 0 0.4], 'LineWidth', 2);  % Sky blue
        end
    end
end

fig = figure(1);  % Get the IRF figure
axes_handles = findall(fig, 'Type', 'Axes');  % Find all subplot axes

% Custom names for each panel (in reverse order because Dynare fills plots from bottom up)
custom_titles = {
    'Heterogeneity Index', ...
    'pi', ...
    'hlog_htm', ...
    'hlog_ricardian', ...
    'clog_htm', ...
    '  clog_ricardian', ...
    'gdp', ...
    'Domestic Tariff', ...
    'Foreign Tariff',
};

% Assign titles
%for i = 1:length(axes_handles)
    title(axes_handles(i), custom_titles{i}, 'FontWeight', 'bold');
%end



